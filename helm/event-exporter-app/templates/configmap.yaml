apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "event-exporter.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels: {{ include "event-exporter.labels" . | nindent 4 }}
data:
  config.yaml: |
    {{- if .Values.watchReasons }}
    watchReasons:
      {{- toYaml .Values.watchReasons | nindent 6 }}
    {{- end }}
    route:
      routes:
      # Cluster events for Slack.
      {{- if .Values.slack.webhook }}
      # Webhook sink.
      - match:
        - kind: Cluster
          apiversion: cluster.x-k8s.io/v1beta2
          reason: UpgradingWithNodeRoll
          component: "cluster-api-events-controller"
          receiver: webhook-upgrade-with-node-roll
      - match:
        - kind: Cluster
          apiversion: cluster.x-k8s.io/v1beta2
          reason: UpgradingWithoutNodeRoll
          component: "cluster-api-events-controller"
          receiver: webhook-upgrade-without-node-roll
      - match:
        - kind: Cluster
          apiversion: cluster.x-k8s.io/v1beta2
          reason: Upgraded
          component: "cluster-api-events-controller"
          receiver: webhook-upgrade-complete
      - match:
        - kind: Cluster
          apiversion: cluster.x-k8s.io/v1beta2
          reason: UpgradedControlPlane
          component: "cluster-api-events-controller"
          receiver: webhook-upgrade-progress
      {{- end }}
      {{- if .Values.slack.token }}
      # Slack sink.
      - match:
        - kind: Cluster
          apiversion: cluster.x-k8s.io/v1beta2
          reason: UpgradingWithNodeRoll|UpgradingWithoutNodeRoll|Upgraded|UpgradedControlPlane
          component: "cluster-api-events-controller"
          receiver: slack-upgrade
      {{- end }}

      # Ignore other events.
      - drop:
        - namespace: "*"

    receivers:
    {{- if .Values.slack.webhook }}
    # Webhook sink - upgrade with node roll (minor/major upgrades).
    - name: webhook-upgrade-with-node-roll
      webhook:
        endpoint: {{ .Values.slack.webhook }}
        layout:
          text: "The cluster upgrade of {{ "{{" }} .InvolvedObject.Namespace {{ "}}" }}/{{ "{{" }} .InvolvedObject.Name {{ "}}" }} on {{ .Values.managementCluster.name }} {{ "{{" }} .Message {{ "}}" }} has begun. This upgrade will replace nodes."

    # Webhook sink - upgrade without node roll (patch upgrades).
    - name: webhook-upgrade-without-node-roll
      webhook:
        endpoint: {{ .Values.slack.webhook }}
        layout:
          text: "The cluster upgrade of {{ "{{" }} .InvolvedObject.Namespace {{ "}}" }}/{{ "{{" }} .InvolvedObject.Name {{ "}}" }} on {{ .Values.managementCluster.name }} {{ "{{" }} .Message {{ "}}" }} has begun. This upgrade will not replace nodes."

    # Upgrade completed.
    - name: webhook-upgrade-complete
      webhook:
        endpoint: {{ .Values.slack.webhook }}
        layout:
          text: "The cluster upgrade of {{ "{{" }} .InvolvedObject.Namespace {{ "}}" }}/{{ "{{" }} .InvolvedObject.Name {{ "}}" }} on {{ .Values.managementCluster.name }} has completed {{ "{{" }} .Message {{ "}}" }}."

    # Upgrade progress.
    - name: webhook-upgrade-progress
      webhook:
        endpoint: {{ .Values.slack.webhook }}
        layout:
          text: "Control plane upgrade completed for {{ "{{" }} .InvolvedObject.Namespace {{ "}}" }}/{{ "{{" }} .InvolvedObject.Name {{ "}}" }} on {{ .Values.managementCluster.name }}"
    {{- end }}
    {{- if .Values.slack.token }}
    # Slack sink.
    - name: slack-upgrade
      slack:
        token: "{{ .Values.slack.token }}"
        channel: "{{ .Values.slack.channel }}"
        {{- if .Values.slack.cache.enabled }}
        cache:
          name: {{ include "event-exporter.fullname" . }}-thread-cache
          namespace: {{ .Release.Namespace }}
        {{- end }}
        threadKey: "{{ "{{" }} .InvolvedObject.Namespace {{ "}}" }}/{{ "{{" }} .InvolvedObject.Name {{ "}}" }}"
        completionCondition: '{{ "{{" }} if eq .Reason "Upgraded" }}true{{ "{{" }} end }}'
        completionEmoji: "white_check_mark"
        message: |
          {{ "{{" }} if eq .Reason "UpgradingWithNodeRoll" -}}
          The cluster upgrade of {{ "{{" }} .InvolvedObject.Namespace }}/{{ "{{" }} .InvolvedObject.Name }} on {{ .Values.managementCluster.name }} {{ "{{" }} .Message }} has begun. This upgrade will replace nodes.
          {{- "{{" }} else if eq .Reason "UpgradingWithoutNodeRoll" -}}
          The cluster upgrade of {{ "{{" }} .InvolvedObject.Namespace }}/{{ "{{" }} .InvolvedObject.Name }} on {{ .Values.managementCluster.name }} {{ "{{" }} .Message }} has begun. This upgrade will not replace nodes.
          {{- "{{" }} else if eq .Reason "Upgraded" -}}
          The cluster upgrade of {{ "{{" }} .InvolvedObject.Namespace }}/{{ "{{" }} .InvolvedObject.Name }} on {{ .Values.managementCluster.name }} has completed {{ "{{" }} .Message }}.
          {{- "{{" }} else if eq .Reason "UpgradedControlPlane" -}}
          :white_check_mark: Control plane upgrade completed for {{ "{{" }} .InvolvedObject.Namespace }}/{{ "{{" }} .InvolvedObject.Name }} on {{ .Values.managementCluster.name }}.
          {{- "{{" }} end }}
    {{- end }}
